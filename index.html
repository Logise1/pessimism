<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>La Prueba</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilos personalizados para el tema oscuro */
        @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&display=swap');
        
        body {
            font-family: 'Roboto Mono', monospace;
        }
        
        /* Efecto de "glitch" sutil para el texto eliminado */
        .text-eliminado {
            color: #ef4444; /* red-500 */
            text-decoration: line-through;
            animation: glitch 0.3s linear infinite;
        }

        /* Animación de aparición */
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Estilo de botones base */
        .btn {
            @apply w-full px-6 py-4 text-lg font-bold uppercase border-2 rounded-md transition-all duration-300 focus:outline-none focus:ring-4 focus:ring-opacity-50;
        }

        .btn-primary {
            @apply bg-white text-black border-white hover:bg-gray-200 focus:ring-white;
        }

        .btn-danger {
            @apply text-red-500 border-red-500 hover:bg-red-500 hover:text-black focus:ring-red-500;
        }

        .btn-secondary {
             @apply text-gray-400 border-gray-400 hover:bg-gray-400 hover:text-black focus:ring-gray-400;
        }

        .btn-disabled {
            @apply text-gray-700 border-gray-700 bg-gray-900 cursor-not-allowed;
        }

        /* Estilo para listas de jugadores */
        .player-list-item {
            @apply px-4 py-2 bg-gray-900 border border-gray-700 rounded-md text-gray-300;
        }
        .player-list-item.survivor {
            @apply border-green-500 text-green-400;
        }
        .player-list-item.eliminated {
            @apply border-red-500 text-red-500 line-through;
        }

    </style>
</head>
<body class="bg-black text-gray-200 min-h-screen flex items-center justify-center p-4">

    <!-- Contenedor principal de la aplicación -->
    <div id="app" class="w-full max-w-4xl mx-auto">
        <!-- Esta pantalla se sobrescribirá con JavaScript -->
        <div class="text-center">
            <h1 class="text-3xl font-bold text-white mb-6">INICIANDO SISTEMA...</h1>
            <p class="text-gray-500">Estableciendo conexión...</p>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Importar funciones de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        // Se elimina la importación de 'auth'
        import { getDatabase, ref, onValue, set, update, onDisconnect, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

        // --- CONFIGURACIÓN DE FIREBASE (PROPORCIONADA POR EL USUARIO) ---
        const firebaseConfig = {
            apiKey: "AIzaSyDrYwIMyL2y7yHXxQF4yjtokPOE2QyHC5I",
            authDomain: "pesimism-2fdad.firebaseapp.com",
            databaseURL: "https://pesimism-2fdad-default-rtdb.europe-west1.firebasedatabase.app", // Corregido el error tipográfico
            projectId: "pesimism-2fdad",
            storageBucket: "pesimism-2fdad.firebasestorage.app",
            messagingSenderId: "859660712236",
            appId: "1:859660712236:web:e09ac663d189f550d2d489",
            measurementId: "G-TYE4V0P8XB"
        };
        
        // --- BANCO DE FRASES ---
        // 'r' = Realista, 'p' = Pesimista
        // Ordenadas de más fácil a más difícil/ambiguo
        const PHRASES = [
            { text: "Eventualmente, todo lo que tiene un principio tiene un fin.", answer: 'r' },
            { text: "No importa cuánto te esfuerces, el fracaso siempre es una posibilidad.", answer: 'r' },
            { text: "La gente siempre actuará en su propio interés, incluso a costa tuya.", answer: 'p' },
            { text: "El sol saldrá mañana, sin importar lo que pase hoy.", answer: 'r' },
            { text: "Toda buena racha está destinada a terminarse.", answer: 'p' },
            { text: "Las estadísticas de accidentes aumentan significativamente durante los días festivos.", answer: 'r' },
            { text: "Confiar en los demás es la forma más rápida de salir lastimado.", answer: 'p' },
            { text: "Un pequeño porcentaje de la población controla la mayoría de los recursos globales.", answer: 'r' },
            { text: "La mayoría de las relaciones humanas están basadas en la conveniencia mutua.", answer: 'p' },
            { text: "La esperanza es solo una negación de la realidad.", answer: 'p' },
            { text: "Incluso las decisiones mejor informadas pueden tener resultados negativos.", answer: 'r' },
            { text: "Al final, estás fundamentalmente solo.", answer: 'p' },
            { text: "La historia humana está definida por el conflicto, no por la paz.", answer: 'r' },
            { text: "Es mejor no esperar nada para nunca sentirse decepcionado.", answer: 'p' }
        ];

        // --- VARIABLES GLOBALES ---
        const app = initializeApp(firebaseConfig);
        // Se elimina la const 'auth'
        const db = getDatabase(app);
        
        let localUserId = null; // Reemplaza a userId de auth
        let isHost = false;
        let gameState = {}; // Caché local del estado del juego
        
        const appElement = document.getElementById('app');
        const gameRef = ref(db, 'la-prueba/game');

        // --- FUNCIÓN PRINCIPAL ---
        function main() {
            // Ya no usamos onAuthStateChanged
            localUserId = crypto.randomUUID(); // Genera un ID local único
            console.log("Sesión local iniciada con ID:", localUserId);
            renderInitialScreen();
        }

        // --- FUNCIONES DE RENDERIZADO (VISTAS) ---

        // Escapar HTML para evitar XSS
        function escapeHTML(str) {
            return str.replace(/[&<>"']/g, function(m) {
                return {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#39;'
                }[m];
            });
        }

        // 1. Pantalla Inicial (Selección de Rol)
        function renderInitialScreen() {
            appElement.innerHTML = `
                <div class="text-center fade-in">
                    <h1 class="text-4xl font-bold text-white mb-8">[ LA PRUEBA ]</h1>
                    <p class="text-gray-400 mb-12">Elige tu rol. Solo puede haber un presentador.</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 max-w-lg mx-auto">
                        <button id="hostBtn" class="btn btn-danger">Modo Presentador</button>
                        <button id="playerBtn" class="btn btn-secondary">Modo Jugador</button>
                    </div>
                </div>
            `;
            document.getElementById('hostBtn').addEventListener('click', joinAsHost);
            document.getElementById('playerBtn').addEventListener('click', joinAsPlayer);
        }

        // 2. Vistas del HOST
        function renderHostLobby(players) {
            const playerCount = Object.keys(players).length;
            appElement.innerHTML = `
                <div class="text-center fade-in">
                    <h1 class="text-3xl font-bold text-red-500 mb-6">SALA DE ESPERA</h1>
                    <p class="text-gray-400 mb-8">Esperando jugadores. Proyecta esta pantalla.</p>
                    <div class="max-w-md mx-auto mb-8">
                        <h2 class="text-xl text-white mb-4">Jugadores Conectados: ${playerCount}</h2>
                        <div id="player-list" class="space-y-2 max-h-60 overflow-y-auto">
                            ${Object.values(players).map(p => 
                                `<div class="player-list-item">${escapeHTML(p.name)}</div>`
                            ).join('')}
                        </div>
                    </div>
                    <button id="startBtn" class="btn btn-primary w-auto mx-auto" ${playerCount === 0 ? 'disabled' : ''}>
                        Comenzar la Prueba
                    </button>
                </div>
            `;
            document.getElementById('startBtn').addEventListener('click', startNextRound);
        }
        
        function renderHostRound(phrase, players) {
            const survivors = Object.values(players).filter(p => !p.isEliminated);
            const votes = survivors.filter(p => p.vote).length;

            appElement.innerHTML = `
                <div class="text-center fade-in max-w-3xl mx-auto">
                    <p class="text-gray-500 text-lg mb-4">Ronda ${gameState.currentRound + 1}</p>
                    <h1 class="text-4xl font-bold text-white mb-12 leading-relaxed">
                        "${escapeHTML(phrase.text)}"
                    </h1>
                    <h2 class="text-2xl text-gray-400 mb-8">
                        ¿Pesimista o Realista?
                    </h2>
                    <p class="text-xl text-white mb-4">Votos recibidos: ${votes} / ${survivors.length}</p>
                    <div class="w-full bg-gray-800 rounded-full h-2.5 mb-8">
                        <div class="bg-green-500 h-2.5 rounded-full" style="width: ${survivors.length > 0 ? (votes / survivors.length) * 100 : 0}%"></div>
                    </div>
                    <button id="revealBtn" class="btn btn-danger w-auto mx-auto">
                        Finalizar Ronda y Revelar
                    </button>
                </div>
            `;
            document.getElementById('revealBtn').addEventListener('click', revealAnswers);
        }

        function renderHostReveal(phrase, players, answer) {
            const survivors = Object.values(players).filter(p => !p.isEliminated);
            const eliminated = Object.values(players).filter(p => p.isEliminated);
            const isGameOver = survivors.length <= 1;

            appElement.innerHTML = `
                <div class="text-center fade-in max-w-4xl mx-auto">
                    <h1 class="text-4xl font-bold mb-6 ${answer === 'r' ? 'text-green-500' : 'text-red-500'}">
                        La respuesta era: ${answer === 'r' ? 'REALISTA' : 'PESIMISTA'}
                    </h1>
                    <p class="text-2xl text-white mb-10">"${escapeHTML(phrase.text)}"</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div>
                            <h2 class="text-2xl text-green-500 font-bold mb-4">SOBREVIVIENTES (${survivors.length})</h2>
                            <div class="space-y-2 max-h-60 overflow-y-auto">
                                ${survivors.map(p => `<div class="player-list-item survivor">${escapeHTML(p.name)}</div>`).join('')}
                            </div>
                        </div>
                        <div>
                            <h2 class="text-2xl text-red-500 font-bold mb-4">ELIMINADOS (${eliminated.length})</h2>
                            <div class="space-y-2 max-h-60 overflow-y-auto">
                                ${eliminated.map(p => `<div class="player-list-item eliminated">${escapeHTML(p.name)}</div>`).join('')}
                            </div>
                        </div>
                    </div>

                    <button id="nextBtn" class="btn btn-primary w-auto mx-auto mt-12">
                        ${isGameOver ? 'Finalizar Juego' : 'Siguiente Ronda'}
                    </button>
                </div>
            `;
            document.getElementById('nextBtn').addEventListener('click', isGameOver ? triggerGameOver : startNextRound);
        }
        
        function renderHostGameOver(winnerName) {
            appElement.innerHTML = `
                <div class="text-center fade-in">
                    <h1 class="text-5xl font-bold text-white mb-6">LA PRUEBA HA TERMINADO</h1>
                    ${winnerName ? 
                        `<p class="text-3xl text-green-400 mb-12">Ganador: ${escapeHTML(winnerName)}</p>` :
                        `<p class="text-3xl text-red-500 mb-12">Nadie ha sobrevivido.</p>`
                    }
                    <button id="resetBtn" class="btn btn-danger w-auto mx-auto">
                        Reiniciar Sala
                    </button>
                </div>
            `;
            document.getElementById('resetBtn').addEventListener('click', initGame);
        }


        // 3. Vistas del JUGADOR
        function renderPlayerLobby(players) {
            const myName = players[localUserId]?.name || "Invitado"; // Usa localUserId
            appElement.innerHTML = `
                <div class="text-center fade-in max-w-md mx-auto">
                    <h1 class="text-3xl font-bold text-white mb-4">SALA DE ESPERA</h1>
                    <p class="text-lg text-gray-400 mb-8">Conectado como: <span class="text-green-400">${escapeHTML(myName)}</span></p>
                    <p class="text-2xl text-gray-200">Esperando que el presentador inicie la prueba...</p>
                    <div class="mt-8">
                        <h3 class="text-lg text-gray-500 mb-3">Otros jugadores:</h3>
                        <div class="space-y-2 max-h-40 overflow-y-auto">
                            ${Object.values(players).filter(p => p.id !== localUserId).map(p => // Usa localUserId
                                `<div class="player-list-item">${escapeHTML(p.name)}</div>`
                            ).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderPlayerVote(phrase) {
            appElement.innerHTML = `
                <div class="text-center fade-in max-w-2xl mx-auto">
                    <p class="text-gray-500 text-lg mb-4">Ronda ${gameState.currentRound + 1}</p>
                    <h1 class="text-3xl font-bold text-white mb-10 leading-relaxed">
                        "${escapeHTML(phrase.text)}"
                    </h1>
                    <p class="text-xl text-gray-300 mb-8">Tu decisión:</p>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                        <button id="voteP" class="btn btn-danger">Pesimista</button>
                        <button id="voteR" class="btn btn-secondary">Realista</button>
                    </div>
                </div>
            `;
            document.getElementById('voteP').addEventListener('click', () => handleVote('p'));
            document.getElementById('voteR').addEventListener('click', () => handleVote('r'));
        }

        function renderPlayerWait(message) {
            appElement.innerHTML = `
                <div class="text-center fade-in max-w-md mx-auto">
                    <h1 class="text-3xl font-bold text-white mb-8">${escapeHTML(message)}</h1>
                    <p class="text-2xl text-gray-400">Esperando al presentador...</p>
                </div>
            `;
        }
        
        function renderPlayerResult(isCorrect) {
             appElement.innerHTML = `
                <div class="text-center fade-in max-w-md mx-auto">
                    <h1 class="text-5xl font-bold ${isCorrect ? 'text-green-500' : 'text-red-500'} mb-8">
                        ${isCorrect ? 'CORRECTO' : 'INCORRECTO'}
                    </h1>
                    <p class="text-2xl text-gray-300">
                        ${isCorrect ? 'Sobrevives... por ahora.' : 'Un error te cuesta todo.'}
                    </p>
                    <p class="text-xl text-gray-500 mt-10">Esperando la siguiente ronda...</p>
                </div>
            `;
        }
        
        function renderPlayerEliminated() {
            appElement.innerHTML = `
                <div class="text-center fade-in max-w-md mx-auto">
                    <h1 class="text-6xl font-bold text-red-700 mb-8">ELIMINADO</h1>
                    <p class="text-2xl text-gray-500">
                        Observa en silencio.
                    </p>
                </div>
            `;
        }

        function renderPlayerGameOver(winnerName) {
            appElement.innerHTML = `
                <div class="text-center fade-in">
                    <h1 class="text-5xl font-bold text-white mb-6">LA PRUEBA HA TERMINADO</h1>
                    ${winnerName ? 
                        `<p class="text-3xl text-green-400 mb-12">Ganador: ${escapeHTML(winnerName)}</p>` :
                        `<p class="text-3xl text-red-500 mb-12">Nadie ha sobrevivido.</p>`
                    }
                    <p class="text-gray-500">Puedes cerrar esta ventana.</p>
                </div>
            `;
        }


        // --- LÓGICA DEL JUEGO (HOST) ---
        
        function joinAsHost() {
            isHost = true;
            console.log("Uniéndose como Host");
            // Comprobar si ya hay un host
            onValue(ref(db, 'la-prueba/hostId'), (snapshot) => {
                const currentHostId = snapshot.val();
                if (currentHostId && currentHostId !== localUserId) { // Usa localUserId
                    alert("¡Error! Ya hay un presentador en esta sala. Únete como jugador.");
                    renderInitialScreen();
                    isHost = false;
                } else {
                    // Tomar control como host
                    set(ref(db, 'la-prueba/hostId'), localUserId); // Usa localUserId
                    onDisconnect(ref(db, 'la-prueba/hostId')).remove();
                    initGame();
                    setupHostListener();
                }
            }, { onlyOnce: true });
        }

        // Inicializa o resetea el juego
        function initGame() {
            set(gameRef, {
                state: 'lobby',
                players: {},
                currentRound: -1,
                currentPhrase: null,
                winner: null
            });
        }

        // El Host inicia la siguiente ronda
        function startNextRound() {
            const currentRound = gameState.currentRound + 1;
            if (currentRound >= PHRASES.length) {
                // Se acabaron las frases
                triggerGameOver();
                return;
            }

            const newPhrase = PHRASES[currentRound];
            
            // Resetear votos de jugadores no eliminados
            const players = gameState.players || {};
            const updates = {};
            Object.keys(players).forEach(pid => {
                if (!players[pid].isEliminated) {
                    updates[`/players/${pid}/vote`] = null;
                    updates[`/players/${pid}/isCorrect`] = null;
                }
            });
            
            updates['/state'] = 'round';
            updates['/currentRound'] = currentRound;
            updates['/currentPhrase'] = newPhrase;
            
            update(gameRef, updates);
        }

        // El Host revela las respuestas
        function revealAnswers() {
            const answer = gameState.currentPhrase.answer;
            const players = gameState.players || {};
            const updates = {};
            
            Object.keys(players).forEach(pid => {
                const player = players[pid];
                if (!player.isEliminated) {
                    const isCorrect = player.vote === answer;
                    updates[`/players/${pid}/isCorrect`] = isCorrect;
                    if (!isCorrect) {
                        updates[`/players/${pid}/isEliminated`] = true;
                    }
                }
            });

            updates['/state'] = 'reveal';
            update(gameRef, updates);
        }

        // El Host termina el juego
        function triggerGameOver() {
            const players = Object.values(gameState.players || {});
            const survivors = players.filter(p => !p.isEliminated);
            const winnerName = survivors.length === 1 ? survivors[0].name : null;

            update(gameRef, {
                state: 'gameover',
                winner: winnerName || (survivors.length > 1 ? "Empate de sobrevivientes" : "Nadie")
            });
        }


        // --- LÓGICA DEL JUEGO (JUGADOR) ---

        function joinAsPlayer() {
            isHost = false;
            const name = prompt("Introduce tu nombre (corto):", "Jugador");
            if (!name) return; // Canceló

            console.log(`Uniéndose como Jugador: ${name}`);
            const playerRef = ref(db, `la-prueba/game/players/${localUserId}`); // Usa localUserId
            
            set(playerRef, {
                id: localUserId, // Usa localUserId
                name: name,
                isEliminated: false,
                vote: null,
                isCorrect: null
            });
            
            // Si el jugador cierra la pestaña, se elimina
            onDisconnect(playerRef).remove();
            
            setupPlayerListener();
        }

        function handleVote(vote) {
            // 'p' o 'r'
            update(ref(db, `la-prueba/game/players/${localUserId}`), { // Usa localUserId
                vote: vote
            });
            renderPlayerWait("Voto registrado.");
        }


        // --- LISTENERS (SINCRONIZACIÓN) ---

        function setupHostListener() {
            onValue(gameRef, (snapshot) => {
                if (!snapshot.exists()) {
                    initGame(); // Si alguien borra la base, el host la recrea
                    return;
                }
                gameState = snapshot.val();
                const { state, players = {}, currentPhrase, winner } = gameState;

                switch (state) {
                    case 'lobby':
                        renderHostLobby(players);
                        break;
                    case 'round':
                        renderHostRound(currentPhrase, players);
                        break;
                    case 'reveal':
                        renderHostReveal(currentPhrase, players, currentPhrase.answer);
                        break;
                    case 'gameover':
                        renderHostGameOver(winner);
                        break;
                    default:
                        console.log("Estado desconocido, reiniciando a lobby");
                        initGame();
                }
            });
        }

        function setupPlayerListener() {
            onValue(gameRef, (snapshot) => {
                if (!snapshot.exists()) {
                    appElement.innerHTML = `<h1 class="text-red-500 text-center">La sala ha sido cerrada por el presentador.</h1>`;
                    setTimeout(renderInitialScreen, 3000);
                    return;
                }
                
                gameState = snapshot.val();
                const { state, players = {}, currentPhrase, winner } = gameState;
                const myData = players[localUserId]; // Usa localUserId

                if (!myData) {
                    // El host reinició el juego o fui eliminado por desconexión
                    console.log("Datos no encontrados, volviendo al inicio");
                    renderInitialScreen();
                    return;
                }
                
                if (myData.isEliminated && state !== 'gameover') {
                    renderPlayerEliminated();
                    return;
                }

                switch (state) {
                    case 'lobby':
                        renderPlayerLobby(players);
                        break;
                    case 'round':
                        if (myData.vote) {
                            renderPlayerWait("Voto registrado.");
                        } else {
                            renderPlayerVote(currentPhrase);
                        }
                        break;
                    case 'reveal':
                        renderPlayerResult(myData.isCorrect);
                        break;
                    case 'gameover':
                        renderPlayerGameOver(winner);
                        break;
                    default:
                        renderPlayerLobby(players);
                }
            });
        }

        // Iniciar la aplicación
        main();

    </script>
</body>
</html>
