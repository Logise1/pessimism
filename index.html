<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>La Prueba</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilos personalizados para el tema oscuro */
        @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&display=swap');
        
        body {
            font-family: 'Roboto Mono', monospace;
        }
        
        /* Efecto de "glitch" sutil para el texto eliminado */
        .text-eliminado {
            color: #ef4444; /* red-500 */
            text-decoration: line-through;
            animation: glitch 0.3s linear infinite;
        }

        /* Animación de aparición */
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Animación de pulso para eventos */
        .animate-pulse {
            animation: pulse 1s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }


        /* Estilo de botones base */
        .btn {
            @apply w-full px-6 py-4 text-lg font-bold uppercase border-2 rounded-md transition-all duration-300 focus:outline-none focus:ring-4 focus:ring-opacity-50;
        }

        .btn-primary {
            @apply bg-white text-black border-white hover:bg-gray-200 focus:ring-white;
        }

        .btn-danger {
            @apply text-red-500 border-red-500 hover:bg-red-500 hover:text-black focus:ring-red-500;
        }

        .btn-secondary {
             @apply text-gray-400 border-gray-400 hover:bg-gray-400 hover:text-black focus:ring-gray-400;
        }

        .btn-disabled {
            @apply text-gray-700 border-gray-700 bg-gray-900 cursor-not-allowed;
        }

        /* Estilo para listas de jugadores */
        .player-list-item {
            @apply px-4 py-2 bg-gray-900 border border-gray-700 rounded-md text-gray-300;
        }
        .player-list-item.survivor {
            @apply border-green-500 text-green-400;
        }
        .player-list-item.eliminated {
            @apply border-red-500 text-red-500 line-through;
        }

    </style>
</head>
<body class="bg-black text-gray-200 min-h-screen flex items-center justify-center p-4">

    <!-- Contenedor principal de la aplicación -->
    <div id="app" class="w-full max-w-4xl mx-auto">
        <!-- Esta pantalla se sobrescribirá con JavaScript -->
        <div class="text-center">
            <h1 class="text-3xl font-bold text-white mb-6">INICIANDO SISTEMA...</h1>
            <p class="text-gray-500">Estableciendo conexión...</p>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Importar funciones de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        // Se elimina la importación de 'auth'
        import { getDatabase, ref, onValue, set, update, onDisconnect, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

        // --- CONFIGURACIÓN DE FIREBASE (PROPORCIONADA POR EL USUARIO) ---
        // (Dejamos la configuración que proporcionaste)
        const firebaseConfig = {
            apiKey: "AIzaSyDrYwIMyL2y7yHXxQF4yjtokPOE2QyHC5I",
            authDomain: "pesimism-2fdad.firebaseapp.com",
            databaseURL: "https://pesimism-2fdad-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "pesimism-2fdad",
            storageBucket: "pesimism-2fdad.firebasestorage.app",
            messagingSenderId: "859660712236",
            appId: "1:859660712236:web:e09ac663d189f550d2d489",
            measurementId: "G-TYE4V0P8XB"
        };
        
        // --- BANCO DE FRASES REESTRUCTURADO POR DIFICULTAD (25 CADA UNA) ---
        // 'r' = Realista, 'p' = Pesimista

        // Súper obvias (25)
        const PHRASES_EASY = [
            { text: "El sol saldrá mañana, sin importar lo que pase hoy.", answer: 'r' },
            { text: "Todas las personas cometen errores.", answer: 'r' },
            { text: "El pasado no se puede cambiar.", answer: 'r' },
            { text: "Las cosas materiales no duran para siempre.", answer: 'r' },
            { text: "El cuerpo humano envejece y eventualmente falla.", answer: 'r' },
            { text: "Cualquier cosa que pueda salir mal, saldrá mal.", answer: 'p' },
            { text: "Las cosas nunca mejorarán.", answer: 'p' },
            { text: "Nunca serás verdaderamente feliz.", answer: 'p' },
            { text: "No importa lo que hagas, al final fracasarás.", answer: 'p' },
            { text: "El agua hierve a 100°C al nivel del mar.", answer: 'r' },
            { text: "La gravedad mantiene los planetas en órbita.", answer: 'r' },
            { text: "Las plantas necesitan luz solar para crecer.", answer: 'r' },
            { text: "Todos los seres vivos eventualmente mueren.", answer: 'r' },
            { text: "El ejercicio regular es bueno para la salud.", answer: 'r' },
            { text: "La noche sigue al día.", answer: 'r' },
            { text: "No puedes respirar bajo el agua sin ayuda.", answer: 'r' },
            { text: "Nunca conseguiré el trabajo de mis sueños.", answer: 'p' },
            { text: "Siempre llueve cuando planeo algo al aire libre.", answer: 'p' },
            { text: "Seguro que este semáforo se pone en rojo.", answer: 'p' },
            { text: "La fila en la que estoy siempre es la más lenta.", answer: 'p' },
            { text: "Se me va a caer la tostada por el lado de la mantequilla.", answer: 'p' },
            { text: "Nadie entiende realmente mis problemas.", answer: 'p' },
            { text: "Aprender una nueva habilidad lleva tiempo.", answer: 'r' },
            { text: "No se puede complacer a todo el mundo.", answer: 'r' },
            { text: "Si algo puede romperse, se romperá.", answer: 'p' }
        ];

        // Requieren pensar un poco (25)
        const PHRASES_MEDIUM = [
            { text: "Confiar ciegamente en desconocidos te hace vulnerable.", answer: 'r' },
            { text: "Nadie consigue todo lo que quiere en la vida.", answer: 'r' },
            { text: "No le puedes caer bien a todo el mundo.", answer: 'r' },
            { text: "El trabajo duro no siempre garantiza el éxito.", answer: 'r' },
            { text: "No siempre obtienes lo que mereces.", answer: 'r' },
            { text: "Los recursos naturales del planeta son finitos.", answer: 'r' },
            { text: "Las estadísticas de accidentes aumentan significativamente durante los días festivos.", answer: 'r' },
            { text: "Toda buena racha está destinada a terminarse.", answer: 'p' },
            { text: "La gente te decepcionará en cuanto tenga la oportunidad.", answer: 'p' },
            { text: "Es mejor no esperar nada para nunca sentirse decepcionado.", answer: 'p' },
            { text: "Si algo parece demasiado bueno para ser verdad, seguro es mentira.", answer: 'p' },
            { text: "La gente solo te ayuda si puede obtener algo a cambio.", answer: 'p' },
            { text: "La mayoría de las nuevas empresas fracasan en los primeros 5 años.", answer: 'r' },
            { text: "El éxito financiero a menudo requiere un grado de suerte.", answer: 'r' },
            { text: "Las relaciones a larga distancia tienen una tasa de fracaso más alta.", answer: 'r' },
            { text: "Es imposible saber con certeza lo que piensan los demás.", answer: 'r' },
            { text: "Cualquier sistema complejo tiene puntos de fallo.", answer: 'r' },
            { text: "La gente tiende a recordar más las experiencias negativas que las positivas.", answer: 'r' },
            { text: "Tus amigos te abandonarán cuando más los necesites.", answer: 'p' },
            { text: "Cualquier plan detallado está condenado al fracaso por un detalle imprevisto.", answer: 'p' },
            { text: "Si das tu opinión honesta, la gente te odiará por ello.", answer: 'p' },
            { text: "El esfuerzo extra nunca es reconocido ni recompensado.", answer: 'p' },
            { text: "La tecnología solo sirve para complicar más las cosas.", answer: 'p' },
            { text: "Toda la comida que sabe bien es mala para la salud.", answer: 'p' },
            { text: "Las promesas están hechas para romperse.", answer: 'p' }
        ];

        // Difíciles (Sutiles, filosóficas) (25)
        const PHRASES_HARD = [
            { text: "La felicidad es un estado químico temporal en el cerebro.", answer: 'r' },
            { text: "La historia humana está definida por el conflicto, no por la paz.", answer: 'r' },
            { text: "No puedes controlar las acciones o sentimientos de otras personas.", answer: 'r' },
            { text: "Incluso las decisiones mejor informadas pueden tener resultados negativos.", answer: 'r' },
            { text: "Un pequeño porcentaje de la población controla la mayoría de los recursos globales.", answer: 'r' },
            { text: "La memoria humana es inherentemente poco fiable.", answer: 'r' },
            { text: "La gente siempre actuará en su propio interés, incluso a costa tuya.", answer: 'p' },
            { text: "Todo esfuerzo es, en última instancia, inútil frente a la inmensidad del tiempo.", answer: 'p' },
            { text: "Al final, estás fundamentalmente solo.", answer: 'p' },
            { text: "Cualquier acto de bondad esconde un motivo egoísta.", answer: 'p' },
            { text: "El mundo es injusto por naturaleza y siempre lo será.", answer: 'p' },
            { text: "Tus logros serán olvidados.", answer: 'p' },
            { text: "El 'libre albedrío' puede ser una ilusión determinada por la neuroquímica.", answer: 'r' },
            { text: "La mayoría de las especies que han existido en la Tierra están extintas.", answer: 'r' },
            { text: "Tu percepción de la realidad es una simulación creada por tu cerebro.", answer: 'r' },
            { text: "Existen sesgos cognitivos que distorsionan tu juicio sin que te des cuenta.", answer: 'r' },
            { text: "El altruismo biológico puede explicarse como una estrategia de 'gen egoísta'.", answer: 'r' },
            { text: "No hay un 'propósito' cósmico inherente a la existencia humana.", answer: 'r' },
            { text: "La justicia es un concepto humano; el universo es indiferente.", answer: 'r' },
            { text: "Toda relación humana es fundamentalmente transaccional.", answer: 'p' },
            { text: "La historia humana es una repetición interminable de los mismos errores.", answer: 'p' },
            { text: "La paz es solo el intervalo entre dos guerras.", answer: 'p' },
            { text: "El progreso es una ilusión; la humanidad no mejora, solo cambia sus vicios.", answer: 'p' },
            { text: "El amor verdadero no existe, es solo una idealización de la dependencia.", answer: 'p' },
            { text: "Cualquier intento de cambiar el sistema solo lo reforzará.", answer: 'p' }
        ];

        // NUEVA CATEGORÍA: Insane (25)
        const PHRASES_INSANE = [
            { text: "El universo terminará eventualmente en la muerte térmica, haciendo que todo sea irrelevante.", answer: 'r' },
            { text: "Estadísticamente, es casi seguro que tus logros serán completamente olvidados en 1000 años.", answer: 'r' },
            { text: "Tus células se reemplazan constantemente; 'tú' no eres la misma persona que eras hace 7 años.", answer: 'r' },
            { text: "No hay evidencia objetiva de que la conciencia sea algo más que un subproducto biológico.", answer: 'r' },
            { text: "La cantidad de sufrimiento en el mundo supera con creces a la cantidad de felicidad.", answer: 'p' },
            { text: "Eres fundamentalmente un esclavo de tu propia biología y tus instintos.", answer: 'p' },
            { text: "Toda interacción social es una mentira performativa.", answer: 'p' },
            { text: "La entropía asegura que todo sistema, incluyéndote a ti y a tus obras, decaerá inevitablemente al caos.", answer: 'r' },
            { text: "Eres un conjunto de datos en un algoritmo que no puedes controlar.", answer: 'p' },
            { text: "La única verdad es el dolor; todo lo demás es una distracción temporal.", answer: 'p' },
            { text: "Tus recuerdos más preciados son probablemente falsos o están distorsionados.", answer: 'r' },
            { text: "El sistema económico global requiere la explotación de una subclase para funcionar.", answer: 'r' },
            { text: "La 'individualidad' es una construcción social; solo eres un producto de tu entorno.", answer: 'p' },
            { text: "Cualquier felicidad que sientas es solo la ausencia temporal de dolor.", answer: 'p' },
            { text: "Eres inherentemente egoísta; cualquier acto de 'bondad' es para sentirte mejor contigo mismo.", answer: 'p' },
            { text: "El genoma humano contiene innumerables 'errores' y ADN viral.", answer: 'r' },
            { text: "Millones de personas han vivido y muerto en el anonimato total. Tú serás uno de ellos.", answer: 'p' },
            { text: "El lenguaje es inherentemente incapaz de transmitir una experiencia verdadera.", answer: 'r' },
            { text: "No existe tal cosa como una decisión 'correcta'; solo hay consecuencias.", answer: 'r' },
            { text: "El universo no te debe nada, ni siquiera una explicación.", answer: 'r' },
            { text: "Nunca podrás escapar de tus propios sesgos.", answer: 'p' },
            { text: "Toda belleza es solo un indicador de aptitud reproductiva.", answer: 'r' },
            { text: "El 'yo' es una narrativa que el cerebro se cuenta a sí mismo.", answer: 'r' },
            { text: "Nada de lo que hagas importará.", answer: 'p' },
            { text: "El destino de la humanidad es autodestruirse.", answer: 'p' }
        ];

        
        // --- VARIABLES GLOBALES ---
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        
        let localUserId = null; // Reemplaza a userId de auth
        let isHost = false;
        let gameState = {}; // Caché local del estado del juego
        
        const appElement = document.getElementById('app');
        const gameRef = ref(db, 'la-prueba/game');
        const hostIdRef = ref(db, 'la-prueba/hostId');

        // --- FUNCIÓN PRINCIPAL ---
        function main() {
            localUserId = crypto.randomUUID(); // Genera un ID local único
            console.log("Sesión local iniciada con ID:", localUserId);
            renderInitialScreen();
        }

        // --- FUNCIONES DE RENDERIZADO (VISTAS) ---

        // Escapar HTML para evitar XSS
        function escapeHTML(str) {
            if (typeof str !== 'string') return '';
            return str.replace(/[&<>"']/g, function(m) {
                return {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#39;'
                }[m];
            });
        }

        // 1. Pantalla Inicial (Selección de Rol)
        function renderInitialScreen() {
            appElement.innerHTML = `
                <div class="text-center fade-in">
                    <h1 class="text-4xl font-bold text-white mb-8">[ LA PRUEBA ]</h1>
                    <p class="text-gray-400 mb-12">Elige tu rol. Solo puede haber un presentador.</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 max-w-lg mx-auto">
                        <button id="hostBtn" class="btn btn-danger">Modo Presentador</button>
                        <button id="playerBtn" class="btn btn-secondary">Modo Jugador</button>
                    </div>
                </div>
            `;
            document.getElementById('hostBtn').addEventListener('click', joinAsHost);
            document.getElementById('playerBtn').addEventListener('click', joinAsPlayer);
        }

        // 2. Vistas del HOST
        function renderHostLobby(players) {
            const playerCount = Object.keys(players).length;
            appElement.innerHTML = `
                <div class="text-center fade-in">
                    <h1 class="text-3xl font-bold text-red-500 mb-6">SALA DE ESPERA</h1>
                    <p class="text-gray-400 mb-8">Esperando jugadores. Proyecta esta pantalla.</p>
                    <div class="max-w-md mx-auto mb-8">
                        <h2 class="text-xl text-white mb-4">Jugadores Conectados: ${playerCount}</h2>
                        <div id="player-list" class="space-y-2 max-h-60 overflow-y-auto">
                            ${Object.values(players).map(p => 
                                `<div class="player-list-item">${escapeHTML(p.name)}</div>`
                            ).join('')}
                        </div>
                    </div>
                    <button id="startBtn" class="btn btn-primary w-auto mx-auto" ${playerCount === 0 ? 'disabled' : ''}>
                        Comenzar la Prueba
                    </button>
                </div>
            `;
            document.getElementById('startBtn').addEventListener('click', startNextRound);
        }
        
        function renderHostRound(phrase, players) {
            const survivors = Object.values(players).filter(p => !p.isEliminated);
            const votes = survivors.filter(p => p.vote).length;
            const votePercentage = survivors.length > 0 ? (votes / survivors.length) * 100 : 0;
            const isSuddenDeath = gameState.specialEvent === 'sudden_death';
            const roundNumber = gameState.currentRound + 1;

            // Determinar dificultad para mostrar
            let difficultyLabel = "FÁCIL";
            if (roundNumber > 75) difficultyLabel = "!!! INSANE !!!";
            else if (roundNumber > 50) difficultyLabel = "DIFÍCIL";
            else if (roundNumber > 25) difficultyLabel = "MEDIO";
            
            let difficultyColor = "text-green-500";
            if (roundNumber > 75) difficultyColor = "text-purple-400 animate-pulse";
            else if (roundNumber > 50) difficultyColor = "text-red-500";
            else if (roundNumber > 25) difficultyColor = "text-yellow-500";


            // --- INICIO DE RENDERIZADO INTELIGENTE ---
            const voteCounter = document.getElementById('vote-counter');
            if (voteCounter && document.getElementById('phrase-text')?.textContent === `"${escapeHTML(phrase.text)}"`) {
                voteCounter.textContent = `Votos recibidos: ${votes} / ${survivors.length}`;
                document.getElementById('vote-progress-bar').style.width = `${votePercentage}%`;
                return; 
            }
            // --- FIN DE RENDERIZADO INTELIGENTE ---

            appElement.innerHTML = `
                <div class="text-center fade-in max-w-3xl mx-auto">
                    <p class="text-gray-500 text-lg mb-2">Ronda ${roundNumber} / 100</p>
                    <p class="text-lg font-bold mb-4 ${difficultyColor}">[ ${difficultyLabel} ]</p>
                    
                    ${isSuddenDeath ? `<h2 class="text-5xl font-bold text-red-700 mb-6 animate-pulse">¡MUERTE SÚBITA!</h2>` : ''}

                    <h1 id="phrase-text" class="text-4xl font-bold text-white mb-12 leading-relaxed">
                        "${escapeHTML(phrase.text)}"
                    </h1>

                    ${isSuddenDeath ? 
                        `<p class="text-2xl text-red-400 mb-8">¡Fallar esta ronda significa la eliminación instantánea!</p>` : 
                        `<h2 class="text-2xl text-gray-400 mb-8">¿Pesimista o Realista?</h2>`
                    }
                    
                    <p id="vote-counter" class="text-xl text-white mb-4">Votos recibidos: ${votes} / ${survivors.length}</p>
                    <div class="w-full bg-gray-800 rounded-full h-2.5 mb-8">
                        <div id="vote-progress-bar" class="bg-green-500 h-2.5 rounded-full transition-all duration-300" style="width: ${votePercentage}%"></div>
                    </div>
                    <button id="revealBtn" class="btn btn-danger w-auto mx-auto">
                        Finalizar Ronda y Revelar
                    </button>
                </div>
            `;
            document.getElementById('revealBtn').addEventListener('click', revealAnswers);
        }

        function renderHostReveal(phrase, players, answer) {
            const survivors = Object.values(players).filter(p => !p.isEliminated);
            const eliminated = Object.values(players).filter(p => p.isEliminated);
            const isGameOver = survivors.length <= 1;

            appElement.innerHTML = `
                <div class="text-center fade-in max-w-4xl mx-auto">
                    <h1 class="text-4xl font-bold mb-6 ${answer === 'r' ? 'text-green-500' : 'text-red-500'}">
                        La respuesta era: ${answer === 'r' ? 'REALISTA' : 'PESIMISTA'}
                    </h1>
                    <p class="text-2xl text-white mb-10">"${escapeHTML(phrase.text)}"</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div>
                            <h2 class="text-2xl text-green-500 font-bold mb-4">SOBREVIVIENTES (${survivors.length})</h2>
                            <div class="space-y-2 max-h-60 overflow-y-auto">
                                ${survivors.map(p => `<div class="player-list-item survivor">${escapeHTML(p.name)} (Vidas: ${p.lives ?? 0})</div>`).join('')}
                            </div>
                        </div>
                        <div>
                            <h2 class="text-2xl text-red-500 font-bold mb-4">ELIMINADOS (${eliminated.length})</h2>
                            <div class="space-y-2 max-h-60 overflow-y-auto">
                                ${eliminated.map(p => `<div class="player-list-item eliminated">${escapeHTML(p.name)}</div>`).join('')}
                            </div>
                        </div>
                    </div>

                    <button id="nextBtn" class="btn btn-primary w-auto mx-auto mt-12">
                        ${isGameOver ? 'Finalizar Juego' : 'Siguiente Ronda'}
                    </button>
                </div>
            `;
            document.getElementById('nextBtn').addEventListener('click', isGameOver ? triggerGameOver : startNextRound);
        }
        
        function renderHostGameOver(winnerName) {
            appElement.innerHTML = `
                <div class="text-center fade-in">
                    <h1 class="text-5xl font-bold text-white mb-6">LA PRUEBA HA TERMINADO</h1>
                    ${winnerName ? 
                        `<p class="text-3xl text-green-400 mb-12">Ganador: ${escapeHTML(winnerName)}</p>` :
                        `<p class="text-3xl text-red-500 mb-12">Nadie ha sobrevivido.</p>`
                    }
                    <button id="resetBtn" class="btn btn-danger w-auto mx-auto">
                        Reiniciar Sala
                    </button>
                </div>
            `;
            document.getElementById('resetBtn').addEventListener('click', initGame);
        }


        // 3. Vistas del JUGADOR
        function renderPlayerLobby(players) {
            const myName = players[localUserId]?.name || "Invitado"; // Usa localUserId
            appElement.innerHTML = `
                <div class="text-center fade-in max-w-md mx-auto">
                    <h1 class="text-3xl font-bold text-white mb-4">SALA DE ESPERA</h1>
                    <p class="text-lg text-gray-400 mb-8">Conectado como: <span class="text-green-400">${escapeHTML(myName)}</span></p>
                    <p class="text-2xl text-gray-200">Esperando que el presentador inicie la prueba...</p>
                    <div class="mt-8">
                        <h3 class="text-lg text-gray-500 mb-3">Otros jugadores:</h3>
                        <div class="space-y-2 max-h-40 overflow-y-auto">
                            ${Object.values(players).filter(p => p.id !== localUserId).map(p => 
                                `<div class="player-list-item">${escapeHTML(p.name)}</div>`
                            ).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderPlayerVote(phrase) {
            const isSuddenDeath = gameState.specialEvent === 'sudden_death';
            const roundNumber = gameState.currentRound + 1;
            
            // Determinar dificultad para mostrar
            let difficultyLabel = "FÁCIL";
            if (roundNumber > 75) difficultyLabel = "!!! INSANE !!!";
            else if (roundNumber > 50) difficultyLabel = "DIFÍCIL";
            else if (roundNumber > 25) difficultyLabel = "MEDIO";
            
            let difficultyColor = "text-green-500";
            if (roundNumber > 75) difficultyColor = "text-purple-400 animate-pulse";
            else if (roundNumber > 50) difficultyColor = "text-red-500";
            else if (roundNumber > 25) difficultyColor = "text-yellow-500";

            appElement.innerHTML = `
                <div class="text-center fade-in max-w-2xl mx-auto">
                    <p class="text-gray-500 text-lg mb-2">Ronda ${roundNumber} / 100</p>
                    <p class="text-lg font-bold mb-4 ${difficultyColor}">[ ${difficultyLabel} ]</p>
                    
                    ${isSuddenDeath ? `<h2 class="text-4xl font-bold text-red-700 mb-6 animate-pulse">¡MUERTE SÚBITA!</h2>` : ''}

                    <h1 class="text-3xl font-bold text-white mb-10 leading-relaxed">
                        "${escapeHTML(phrase.text)}"
                    </h1>

                    ${isSuddenDeath ? 
                        `<p class="text-xl text-red-400 mb-8">Si fallas, pierdes todas tus vidas.</p>` : 
                        `<p class="text-xl text-gray-300 mb-8">Tu decisión:</p>`
                    }

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                        <button id="voteP" class="btn btn-danger">Pesimista</button>
                        <button id="voteR" class="btn btn-secondary">Realista</button>
                    </div>
                </div>
            `;
            document.getElementById('voteP').addEventListener('click', () => handleVote('p'));
            document.getElementById('voteR').addEventListener('click', () => handleVote('r'));
        }

        function renderPlayerWait(message) {
            appElement.innerHTML = `
                <div class="text-center fade-in max-w-md mx-auto">
                    <h1 class="text-3xl font-bold text-white mb-8">${escapeHTML(message)}</h1>
                    <p class="text-2xl text-gray-400">Esperando al presentador...</p>
                </div>
            `;
        }
        
        function renderPlayerResult(isCorrect, lives) {
             const lifeMessage = isCorrect ? 
                'Sobrevives... por ahora.' : 
                (lives > 0 ? `Has perdido una vida. Te quedan ${lives}.` : 'Un error te cuesta todo.');

             appElement.innerHTML = `
                <div class="text-center fade-in max-w-md mx-auto">
                    <h1 class="text-5xl font-bold ${isCorrect ? 'text-green-500' : 'text-red-500'} mb-8">
                        ${isCorrect ? 'CORRECTO' : 'INCORRECTO'}
                    </h1>
                    <p class="text-2xl text-gray-300">
                        ${lifeMessage}
                    </p>
                    <p class="text-xl text-gray-500 mt-10">Esperando la siguiente ronda...</p>
                </div>
            `;
        }
        
        function renderPlayerEliminated() {
            appElement.innerHTML = `
                <div class="text-center fade-in max-w-md mx-auto">
                    <h1 class="text-6xl font-bold text-red-700 mb-8">ELIMINADO</h1>
                    <p class="text-2xl text-gray-500">
                        Observa en silencio.
                    </p>
                </div>
            `;
        }

        function renderPlayerGameOver(winnerName) {
            appElement.innerHTML = `
                <div class="text-center fade-in">
                    <h1 class="text-5xl font-bold text-white mb-6">LA PRUEBA HA TERMINADO</h1>
                    ${winnerName ? 
                        `<p class="text-3xl text-green-400 mb-12">Ganador: ${escapeHTML(winnerName)}</p>` :
                        `<p class="text-3xl text-red-500 mb-12">Nadie ha sobrevivido.</p>`
                    }
                    <p class="text-gray-500">Puedes cerrar esta ventana.</p>
                </div>
            `;
        }


        // --- LÓGICA DEL JUEGO (HOST) ---
        
        function joinAsHost() {
            isHost = true;
            console.log("Intentando unirse como Host");
            
            onValue(hostIdRef, (snapshot) => {
                const currentHostId = snapshot.val();
                if (currentHostId && currentHostId !== localUserId) {
                    // Reemplazamos alert() por una vista de error temporal
                    appElement.innerHTML = `
                        <div class="text-center fade-in">
                            <h1 class="text-3xl font-bold text-red-500 mb-6">ERROR</h1>
                            <p class="text-gray-300">Ya hay un presentador en esta sala. Únete como jugador.</p>
                        </div>
                    `;
                    setTimeout(renderInitialScreen, 3000); // Volver al inicio
                    isHost = false;
                } else {
                    set(hostIdRef, localUserId); 
                    onDisconnect(hostIdRef).remove(); 
                    
                    setupHostListener();
                }
            }, { onlyOnce: true }); 
        }

        // Inicializa o resetea el juego
        function initGame() {
            console.log("INICIALIZANDO JUEGO NUEVO CON DIFICULTAD PROGRESIVA (100 FRASES)");
            
            // 1. Barajar cada categoría de dificultad por separado
            const shuffledEasy = [...PHRASES_EASY].sort(() => Math.random() - 0.5);
            const shuffledMedium = [...PHRASES_MEDIUM].sort(() => Math.random() - 0.5);
            const shuffledHard = [...PHRASES_HARD].sort(() => Math.random() - 0.5);
            const shuffledInsane = [...PHRASES_INSANE].sort(() => Math.random() - 0.5); // Barajar la nueva categoría

            // 2. Concatenarlas en orden de dificultad
            const finalShuffledList = [...shuffledEasy, ...shuffledMedium, ...shuffledHard, ...shuffledInsane];

            set(gameRef, {
                state: 'lobby',
                players: {},
                currentRound: -1,
                currentPhrase: null,
                // Almacena la lista de 100 frases barajadas por categoría
                shuffledPhrases: finalShuffledList, 
                specialEvent: null,
                winner: null
            });
        }

        // El Host inicia la siguiente ronda
        function startNextRound() {
            const currentRound = gameState.currentRound + 1;
            // Obtener la frase directamente de la lista ordenada en Firebase
            const newPhrase = gameState.shuffledPhrases[currentRound];

            if (typeof newPhrase === 'undefined') {
                // Se acabaron las 100 frases
                triggerGameOver();
                return;
            }

            const players = gameState.players || {};
            const updates = {};
            Object.keys(players).forEach(pid => {
                if (!players[pid].isEliminated) {
                    updates[`/players/${pid}/vote`] = null;
                    updates[`/players/${pid}/isCorrect`] = null;
                }
            });
            
            // Decidir si hay un evento especial
            let eventType = null;
            // Reducimos la probabilidad para que no sea tan frecuente en 100 rondas
            if (Math.random() < 0.20) { // 20% de probabilidad
                eventType = 'sudden_death';
            }
            updates['/specialEvent'] = eventType;

            updates['/state'] = 'round';
            updates['/currentRound'] = currentRound;
            updates['/currentPhrase'] = newPhrase;
            
            update(gameRef, updates);
        }

        // El Host revela las respuestas
        function revealAnswers() {
            const answer = gameState.currentPhrase.answer;
            const players = gameState.players || {};
            const updates = {};
            const isSuddenDeath = gameState.specialEvent === 'sudden_death';
            
            Object.keys(players).forEach(pid => {
                const player = players[pid];
                if (!player.isEliminated) {
                    const isCorrect = player.vote === answer;
                    updates[`/players/${pid}/isCorrect`] = isCorrect;
                    
                    if (!isCorrect) {
                        if (isSuddenDeath) {
                            updates[`/players/${pid}/lives`] = 0;
                            updates[`/players/${pid}/isEliminated`] = true;
                        } else {
                            const newLives = (player.lives ?? 2) - 1; 
                            updates[`/players/${pid}/lives`] = newLives;
                            if (newLives <= 0) {
                                updates[`/players/${pid}/isEliminated`] = true;
                            }
                        }
                    }
                }
            });

            updates['/state'] = 'reveal';
            update(gameRef, updates);
        }

        // El Host termina el juego
        function triggerGameOver() {
            const players = Object.values(gameState.players || {});
            const survivors = players.filter(p => !p.isEliminated);
            const winnerName = survivors.length === 1 ? survivors[0].name : null;

            update(gameRef, {
                state: 'gameover',
                winner: winnerName || (survivors.length > 1 ? "Empate" : "Nadie")
            });
        }


        // --- LÓGICA DEL JUEGO (JUGADOR) ---

        function joinAsPlayer() {
            isHost = false;
            const name = prompt("Introduce tu nombre (corto):", "Jugador");
            if (!name) return; // Canceló

            console.log(`Uniéndose como Jugador: ${name}`);
            const playerRef = ref(db, `la-prueba/game/players/${localUserId}`);
            
            set(playerRef, {
                id: localUserId,
                name: name,
                lives: 2, // Empezar con 2 vidas
                isEliminated: false,
                vote: null,
                isCorrect: null
            });
            
            onDisconnect(playerRef).remove();
            
            setupPlayerListener();
        }

        function handleVote(vote) {
            update(ref(db, `la-prueba/game/players/${localUserId}`), { 
                vote: vote
            });
            renderPlayerWait("Voto registrado.");
        }


        // --- LISTENERS (SINCRONIZACIÓN) ---

        function setupHostListener() {
            onValue(gameRef, (snapshot) => {
                if (!snapshot.exists()) {
                    initGame(); 
                    return;
                }
                gameState = snapshot.val();
                
                // Si el juego existe pero no tiene la lista de frases (juego antiguo), reinícialo
                if (!gameState.shuffledPhrases || gameState.shuffledPhrases.length < 100) {
                    initGame();
                    return;
                }

                const { state, players = {}, currentPhrase, winner } = gameState;

                switch (state) {
                    case 'lobby':
                        renderHostLobby(players);
                        break;
                    case 'round':
                        renderHostRound(currentPhrase, players);
                        break;
                    case 'reveal':
                        renderHostReveal(currentPhrase, players, currentPhrase.answer);
                        break;
                    case 'gameover':
                        renderHostGameOver(winner);
                        break;
                    default:
                        console.log("Estado desconocido, reiniciando a lobby");
                        initGame();
                }
            });
        }

        function setupPlayerListener() {
            onValue(gameRef, (snapshot) => {
                if (!snapshot.exists()) {
                    appElement.innerHTML = `<h1 class="text-red-500 text-center">La sala ha sido cerrada por el presentador.</h1>`;
                    setTimeout(renderInitialScreen, 3000);
                    return;
                }
                
                gameState = snapshot.val();
                const { state, players = {}, currentPhrase, winner } = gameState;
                const myData = players[localUserId]; 

                if (!myData && state !== 'lobby') { // Si no estoy en la lista Y el juego ya empezó
                    console.log("Datos no encontrados, volviendo al inicio");
                    renderInitialScreen();
                    return;
                }
                
                // Manejo especial si me uno tarde (o si el host resetea)
                if (state === 'lobby' && !myData) {
                    joinAsPlayer(); // Intentar unirse de nuevo
                    return;
                }

                if (myData && myData.isEliminated && state !== 'gameover') {
                    renderPlayerEliminated();
                    return;
                }

                switch (state) {
                    case 'lobby':
                        renderPlayerLobby(players);
                        break;
                    case 'round':
                        if (myData.vote) {
                            renderPlayerWait("Voto registrado.");
                        } else {
                            renderPlayerVote(currentPhrase);
                        }
                        break;
                    case 'reveal':
                        renderPlayerResult(myData.isCorrect, myData.lives);
                        break;
                    case 'gameover':
                        renderPlayerGameOver(winner);
                        break;
                    default:
                        renderPlayerLobby(players);
                }
            });
        }

        // Iniciar la aplicación
        main();

    </script>
</body>
</html>
